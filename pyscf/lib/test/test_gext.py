#!/usr/bin/env python
# Copyright 2014-2018 The PySCF Developers. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import unittest
import numpy as np
from pyscf import lib, gto, dft

def setUpModule():
    global mol, mf, nelectrons, mos, hcores, overlaps, \
        ref_guess, ref_coeffs

    # Example molecule
    mol = gto.Mole()
    mol.atom = """
        O   0.20000000   0.49999999   0.00000000
        H   1.16000000   0.49999999   0.00000000
        H  -0.12045459   1.40493582   0.00000000"""

    mol.basis = "6-31G(d)"
    mol.symmetry = True
    mol.build()
    mol.verbose = 0
    mf = dft.RKS(mol)
    mf.xc = "B3LYP"

    # Data from ethane geometry optimization
    nelectrons = 18

    mos = [np.array(mat) for mat in \
        [[[ 7.01069207e-01, 7.01778211e-01,-1.65268907e-01,-1.46142221e-01,
            4.78400402e-09, 1.15673814e-09, 1.99015223e-02,-1.06253186e-08,
           -2.21154308e-08, 7.46171336e-09, 5.31124085e-10, 6.96948073e-02,
           -1.49774382e-01, 1.90298099e-01, 4.73615842e-08, 3.01862940e-09],
          [ 3.06053514e-02, 2.26669537e-02, 4.54180290e-01, 4.41368422e-01,
           -1.89711257e-08,-4.61369582e-09,-8.50704429e-02, 4.41580174e-08,
            9.18289472e-08,-4.69640908e-08,-3.12653636e-09,-3.89369799e-01,
            9.61550596e-01,-1.20266695e+00,-3.21272153e-07,-1.80594216e-08],
          [ 6.45633810e-13,-5.32308324e-13, 1.25463671e-11,-4.14129041e-11,
           -9.61128775e-02, 3.87742629e-01,-8.81337922e-09,-3.68816992e-01,
            1.68949423e-01, 2.10398782e-02, 7.22971102e-01,-5.46562282e-09,
            8.64224805e-09, 2.90827446e-08,-3.86495361e-02,-8.51269270e-01],
          [ 2.43808386e-10, 2.78987480e-10, 5.66909697e-09, 1.36775392e-08,
            3.87742626e-01, 9.61128777e-02, 5.29119514e-07, 1.68949423e-01,
            3.68816989e-01, 7.22971101e-01,-2.10398818e-02, 2.43502664e-07,
           -2.83871958e-07,-1.58528032e-07,-8.51269269e-01, 3.86495330e-02],
          [-2.87015500e-03, 3.12385723e-03,-6.23025163e-02, 1.45563124e-01,
           -6.17849364e-09,-1.07645435e-09, 5.44096976e-01,-3.05727013e-07,
           -6.40047846e-07,-3.27515418e-07, 1.33081136e-08, 9.96793857e-01,
            4.25311379e-01,-4.26736139e-02,-1.50885066e-07, 6.51490433e-09],
          [-7.01069071e-01, 7.01778347e-01,-1.65268907e-01, 1.46142221e-01,
           -4.88375229e-09,-1.10640597e-09, 1.99015224e-02,-1.05150543e-08,
           -2.20706165e-08,-8.70487225e-09, 1.18797631e-09,-6.96948081e-02,
           -1.49774379e-01,-1.90298101e-01, 5.75671084e-08,-9.40055797e-09],
          [-3.06053470e-02, 2.26669597e-02, 4.54180291e-01,-4.41368422e-01,
            1.94375281e-08, 4.32718192e-09,-8.50704432e-02, 4.35623537e-08,
            9.16431346e-08, 5.45140608e-08,-7.17676786e-09, 3.89369804e-01,
            9.61550578e-01, 1.20266696e+00,-3.86292930e-07, 6.12729482e-08],
          [-6.92389189e-12, 6.62347973e-12, 1.86656301e-10,-3.73062416e-10,
           -9.61128784e-02, 3.87742630e-01, 8.25782949e-09, 3.68816991e-01,
           -1.68949424e-01, 2.10398813e-02, 7.22971098e-01,-3.40613003e-09,
           -1.60753555e-10,-2.47906332e-08, 3.86495328e-02, 8.51269274e-01],
          [ 2.51645870e-10,-2.85391305e-10,-5.84384937e-09, 1.39615377e-08,
            3.87742627e-01, 9.61128771e-02,-5.28638347e-07,-1.68949422e-01,
           -3.68816989e-01, 7.22971099e-01,-2.10398782e-02, 2.41926551e-07,
            2.77184506e-07,-1.10207960e-07, 8.51269272e-01,-3.86495364e-02],
          [-2.87015560e-03,-3.12385667e-03, 6.23025161e-02, 1.45563125e-01,
           -5.39622421e-09,-1.64373463e-09,-5.44096976e-01, 3.05864107e-07,
            6.40111619e-07,-3.30927102e-07, 1.79358122e-08, 9.96793855e-01,
           -4.25311384e-01,-4.26736202e-02, 1.55219329e-07,-1.22017169e-08],
          [-4.96725990e-03,-4.87840285e-03, 1.11403423e-01, 1.70023506e-01,
            8.66613401e-02, 3.00673781e-01, 1.44879551e-01,-2.25762424e-01,
            3.17816799e-01,-3.76730174e-01,-6.10766112e-01,-1.37204772e-01,
           -5.18271863e-01, 5.27712711e-01, 3.69835653e-01, 5.78305161e-01],
          [-4.96725966e-03,-4.87840260e-03, 1.11403417e-01, 1.70023490e-01,
           -3.03721814e-01,-7.52859641e-02, 1.44878797e-01,-1.62356484e-01,
           -3.54424581e-01, 7.17304230e-01,-2.08749637e-02,-1.37204414e-01,
           -5.18272197e-01, 5.27712507e-01,-6.85744513e-01, 3.11343520e-02],
          [-4.96725990e-03,-4.87840285e-03, 1.11403423e-01, 1.70023506e-01,
            2.17060452e-01,-2.25387821e-01, 1.44879565e-01, 3.88118660e-01,
            3.66072625e-02,-3.40573686e-01, 6.31641067e-01,-1.37204781e-01,
           -5.18271849e-01, 5.27712752e-01, 3.15909379e-01,-6.09439494e-01],
          [ 4.96725897e-03,-4.87840382e-03, 1.11403423e-01,-1.70023506e-01,
           -2.17060453e-01, 2.25387822e-01, 1.44879565e-01, 3.88118659e-01,
            3.66072622e-02, 3.40573679e-01,-6.31641057e-01, 1.37204776e-01,
           -5.18271854e-01,-5.27712703e-01, 3.15909412e-01,-6.09439534e-01],
          [ 4.96725871e-03,-4.87840356e-03, 1.11403417e-01,-1.70023490e-01,
            3.03721814e-01, 7.52859637e-02, 1.44878798e-01,-1.62356483e-01,
           -3.54424581e-01,-7.17304232e-01, 2.08749665e-02, 1.37204412e-01,
           -5.18272184e-01,-5.27712553e-01,-6.85744486e-01, 3.11343196e-02],
          [ 4.96725895e-03,-4.87840381e-03, 1.11403423e-01,-1.70023506e-01,
           -8.66613398e-02,-3.00673781e-01, 1.44879551e-01,-2.25762424e-01,
            3.17816799e-01, 3.76730171e-01, 6.10766117e-01, 1.37204770e-01,
           -5.18271852e-01,-5.27712736e-01, 3.69835681e-01, 5.78305127e-01]],
         [[-7.01059441e-01, 7.01770624e-01,-1.65403973e-01, 1.45593563e-01,
           -1.42100225e-09, 1.90803677e-11,-2.23902675e-02,-3.43087291e-09,
            8.88671387e-11,-5.05399743e-11,-2.61721721e-09, 1.02759806e-01,
           -1.49725245e-01,-1.75223900e-01, 4.02369716e-09, 2.19002304e-08],
          [-3.06463996e-02, 2.28356621e-02, 4.54917962e-01,-4.36597864e-01,
            5.97816133e-09,-6.67545076e-11, 9.50755966e-02, 1.32098690e-08,
           -3.58717395e-10, 3.54013188e-10, 1.44276903e-08,-5.90643899e-01,
            9.72820119e-01, 1.12104318e+00,-2.56336028e-08,-1.49331056e-07],
          [ 8.62607758e-13, 8.01778252e-13,-2.16201089e-11,-4.59147227e-11,
            3.69305900e-03, 4.01412030e-01,-1.18354560e-09,-3.24395366e-03,
           -4.06533534e-01, 7.20461727e-01, 7.37141612e-03, 4.64010981e-10,
           -3.97891689e-09, 2.38360400e-08, 8.52469842e-01, 7.22816426e-03],
          [ 6.63739465e-11,-9.22684541e-11,-1.74731707e-09, 4.66485672e-09,
            4.01412030e-01,-3.69305917e-03, 6.94142738e-08,-4.06533534e-01,
            3.24395349e-03,-7.37141521e-03, 7.20461731e-01,-5.05326615e-08,
            1.35610055e-07,-5.87191543e-08,-7.22816510e-03, 8.52469845e-01],
          [ 2.54528444e-03, 3.37650093e-03,-5.55293897e-02,-1.48386112e-01,
            2.70150337e-09,-2.76532870e-10,-5.40277922e-01,-9.13734359e-08,
            2.07021941e-09,-7.71175953e-10, 7.60368865e-08, 9.71734548e-01,
            4.45058536e-01, 2.39862810e-01,-4.57621159e-09,-6.96477679e-08],
          [ 7.01059492e-01, 7.01770573e-01,-1.65403973e-01,-1.45593563e-01,
            1.44767761e-09,-6.84362714e-11,-2.23902675e-02,-3.40651391e-09,
            5.30315819e-11,-4.59978656e-10, 2.94085235e-09,-1.02759806e-01,
           -1.49725246e-01, 1.75223899e-01,-5.44218953e-09, 2.75897844e-08],
          [ 3.06464012e-02, 2.28356599e-02, 4.54917962e-01, 4.36597864e-01,
           -6.10752409e-09, 2.98938673e-10, 9.50755964e-02, 1.30798628e-08,
           -1.65655454e-10, 2.67699606e-09,-1.63473392e-08, 5.90643898e-01,
            9.72820128e-01,-1.12104317e+00, 3.52388163e-08,-1.85935616e-07],
          [-3.37705558e-12,-4.45517461e-12,-8.48672193e-11,-2.02789403e-10,
            3.69305916e-03, 4.01412029e-01, 1.02258820e-09, 3.24395349e-03,
            4.06533534e-01, 7.20461729e-01, 7.37141513e-03, 4.59714117e-10,
            1.27732215e-09,-2.17599832e-08,-8.52469840e-01,-7.22816502e-03],
          [ 6.88227656e-11, 9.42804052e-11, 1.80748166e-09, 4.76020038e-09,
            4.01412030e-01,-3.69305899e-03,-6.92496642e-08, 4.06533535e-01,
           -3.24395364e-03,-7.37141598e-03, 7.20461731e-01,-5.02764555e-08,
           -1.33895873e-07,-3.06328753e-08, 7.22816411e-03,-8.52469844e-01],
          [ 2.54528419e-03,-3.37650111e-03, 5.55293897e-02,-1.48386112e-01,
            2.48457457e-09,-2.20490583e-11, 5.40277922e-01, 9.14087601e-08,
           -2.15571568e-09,-2.29348864e-09, 7.69483201e-08, 9.71734548e-01,
           -4.45058537e-01, 2.39862807e-01,-8.47471764e-09, 7.78458823e-08],
          [ 5.02452981e-03,-4.93896069e-03, 1.12432225e-01,-1.68609184e-01,
            1.59348680e-01, 2.70227846e-01,-1.43292134e-01,-1.97337886e-01,
           -3.35586400e-01,-6.20084567e-01,-3.66515499e-01,-4.54835352e-02,
           -5.24021012e-01,-5.46741482e-01,-5.95052113e-01,-3.50313853e-01],
          [ 5.02452991e-03,-4.93896079e-03, 1.12432227e-01,-1.68609190e-01,
           -3.13698515e-01, 2.88607982e-03,-1.43292231e-01, 3.89295253e-01,
           -3.10639949e-03,-7.36941999e-03, 7.20266696e-01,-4.54836083e-02,
           -5.24020853e-01,-5.46741551e-01,-5.85468835e-03, 6.90487308e-01],
          [ 5.02452981e-03,-4.93896069e-03, 1.12432225e-01,-1.68609184e-01,
            1.54349843e-01,-2.73113926e-01,-1.43292132e-01,-1.91957443e-01,
            3.38692802e-01, 6.27453988e-01,-3.53751288e-01,-4.54835347e-02,
           -5.24021018e-01,-5.46741448e-01, 6.00906838e-01,-3.40173216e-01],
          [-5.02453017e-03,-4.93896032e-03, 1.12432225e-01, 1.68609184e-01,
           -1.54349843e-01, 2.73113925e-01,-1.43292132e-01,-1.91957444e-01,
            3.38692802e-01,-6.27453990e-01, 3.53751290e-01, 4.54835352e-02,
           -5.24021019e-01, 5.46741487e-01, 6.00906807e-01,-3.40173197e-01],
          [-5.02453027e-03,-4.93896042e-03, 1.12432227e-01, 1.68609190e-01,
            3.13698515e-01,-2.88607957e-03,-1.43292231e-01, 3.89295253e-01,
           -3.10639942e-03, 7.36941863e-03,-7.20266695e-01, 4.54836084e-02,
           -5.24020859e-01, 5.46741524e-01,-5.85471678e-03, 6.90487325e-01],
          [-5.02453017e-03,-4.93896033e-03, 1.12432225e-01, 1.68609184e-01,
           -1.59348680e-01,-2.70227846e-01,-1.43292134e-01,-1.97337886e-01,
           -3.35586401e-01, 6.20084566e-01, 3.66515500e-01, 4.54835356e-02,
           -5.24021017e-01, 5.46741457e-01,-5.95052142e-01,-3.50313836e-01]],
          [[-7.01056804e-01, 7.01765086e-01,-1.65597199e-01, 1.45551518e-01,
           -1.88202595e-10, 1.00703292e-11,-2.15664829e-02,-5.14450261e-10,
            2.67428800e-11,-3.45053412e-11, 1.04585670e-10, 9.23775464e-02,
           -1.49650394e-01,-1.81214192e-01, 2.62883282e-10, 2.57051895e-09],
          [-3.07420818e-02, 2.27839440e-02, 4.54608109e-01,-4.37548495e-01,
            7.65084088e-10,-3.98934052e-11, 9.07358581e-02, 2.03054823e-09,
           -1.08089476e-10, 2.05388191e-10,-6.39486709e-10,-5.30970837e-01,
            9.69289373e-01, 1.15503716e+00,-1.65219188e-09,-1.74359004e-08],
          [ 6.25071617e-13, 6.35497809e-13,-1.35509830e-11,-3.07215407e-11,
            2.00067408e-02, 4.00661554e-01,-3.09745067e-10,-1.16538316e-02,
           -4.06243978e-01, 7.19774749e-01, 1.20190569e-02, 3.91035904e-10,
           -3.10281330e-10, 1.78192801e-09, 8.53276920e-01, 1.54434933e-02],
          [ 6.69878718e-12,-1.16706354e-11,-1.81203174e-10, 5.92653893e-10,
            4.00661554e-01,-2.00067409e-02, 1.04145295e-08,-4.06243978e-01,
            1.16538316e-02,-1.20190568e-02, 7.19774749e-01,-9.32429932e-09,
            1.53954432e-08,-5.96124339e-09,-1.54434934e-02, 8.53276920e-01],
          [ 2.69178452e-03, 3.29572266e-03,-5.88901000e-02,-1.48407794e-01,
            3.67037092e-10,-1.10563417e-10,-5.40600490e-01,-1.38162100e-08,
            7.37753102e-10,-5.49429033e-10, 1.28085688e-08, 9.88945473e-01,
            4.41187163e-01, 1.74481491e-01,-2.24746766e-10,-8.05732706e-09],
          [ 7.01056811e-01, 7.01765079e-01,-1.65597199e-01,-1.45551518e-01,
            1.90722436e-10,-1.45327234e-11,-2.15664829e-02,-5.10727800e-10,
            2.37340501e-11,-1.65255303e-11,-6.54330066e-11,-9.23775464e-02,
           -1.49650394e-01, 1.81214192e-01,-4.60681560e-10, 3.07539940e-09],
          [ 3.07420821e-02, 2.27839437e-02, 4.54608109e-01, 4.37548495e-01,
           -7.76963493e-10, 6.14736093e-11, 9.07358581e-02, 2.01259795e-09,
           -9.08201980e-11, 9.67572032e-11, 4.04956058e-10, 5.30970837e-01,
            9.69289374e-01,-1.15503716e+00, 2.99129067e-09,-2.06769420e-08],
          [ 2.46031074e-13,-9.66321392e-13, 3.56668994e-12,-4.53393292e-11,
            2.00067409e-02, 4.00661554e-01, 2.98222606e-10, 1.16538316e-02,
            4.06243978e-01, 7.19774749e-01, 1.20190567e-02, 3.85854272e-10,
            4.44970523e-11,-1.56652749e-09,-8.53276920e-01,-1.54434933e-02],
          [ 6.96721705e-12, 1.18670376e-11, 1.86768251e-10, 6.03158587e-10,
            4.00661554e-01,-2.00067408e-02,-1.03812779e-08, 4.06243979e-01,
           -1.16538316e-02,-1.20190568e-02, 7.19774749e-01,-9.22556533e-09,
           -1.51918561e-08,-3.48863636e-09, 1.54434932e-02,-8.53276920e-01],
          [ 2.69178449e-03,-3.29572268e-03, 5.88901000e-02,-1.48407794e-01,
            3.29510095e-10,-8.82058791e-11, 5.40600490e-01, 1.38170665e-08,
           -7.46123083e-10,-7.01535851e-10, 1.29081253e-08, 9.88945473e-01,
           -4.41187163e-01, 1.74481490e-01,-4.89436499e-10, 8.68234931e-09],
          [ 5.00954675e-03,-4.92300001e-03, 1.11580877e-01,-1.69096345e-01,
            1.69770849e-01, 2.62841533e-01,-1.44306612e-01,-2.04606349e-01,
           -3.32021927e-01,-6.17047065e-01,-3.70124261e-01,-7.77967475e-02,
           -5.22336516e-01,-5.42109616e-01,-5.90320801e-01,-3.55217950e-01],
          [ 5.00954676e-03,-4.92300002e-03, 1.11580877e-01,-1.69096346e-01,
           -3.12512869e-01, 1.56051009e-02,-1.44306626e-01, 3.89842592e-01,
           -1.11833286e-02,-1.20134764e-02, 7.19440558e-01,-7.77967609e-02,
           -5.22336498e-01,-5.42109623e-01,-1.24673747e-02, 6.88841800e-01],
          [ 5.00954675e-03,-4.92300001e-03, 1.11580877e-01,-1.69096345e-01,
            1.42742021e-01,-2.78446634e-01,-1.44306612e-01,-1.85236255e-01,
            3.43205256e-01, 6.29060541e-01,-3.49316309e-01,-7.77967472e-02,
           -5.22336516e-01,-5.42109613e-01, 6.02788178e-01,-3.33623822e-01],
          [-5.00954680e-03,-4.92299996e-03, 1.11580877e-01, 1.69096345e-01,
           -1.42742021e-01, 2.78446634e-01,-1.44306612e-01,-1.85236255e-01,
            3.43205256e-01,-6.29060541e-01, 3.49316310e-01, 7.77967473e-02,
           -5.22336516e-01, 5.42109616e-01, 6.02788176e-01,-3.33623821e-01],
          [-5.00954681e-03,-4.92299997e-03, 1.11580877e-01, 1.69096346e-01,
            3.12512869e-01,-1.56051008e-02,-1.44306626e-01, 3.89842592e-01,
           -1.11833285e-02, 1.20134760e-02,-7.19440558e-01, 7.77967609e-02,
           -5.22336498e-01, 5.42109621e-01,-1.24673764e-02, 6.88841802e-01],
          [-5.00954680e-03,-4.92299996e-03, 1.11580877e-01, 1.69096345e-01,
           -1.69770849e-01,-2.62841533e-01,-1.44306612e-01,-2.04606348e-01,
           -3.32021927e-01, 6.17047065e-01, 3.70124261e-01, 7.77967477e-02,
           -5.22336516e-01, 5.42109614e-01,-5.90320803e-01,-3.55217948e-01]]]]

    overlaps = [np.array(mat) for mat in \
        [[[ 1.00000000e+00, 2.48362390e-01, 0.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 6.39821020e-08, 2.66205137e-02, 0.00000000e+00,
           0.00000000e+00, 4.46376366e-02, 6.22758564e-02, 6.22758520e-02,
           6.22758564e-02, 5.31031726e-03, 5.31031704e-03, 5.31031725e-03],
         [ 2.48362390e-01, 1.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 2.66205137e-02, 2.98706483e-01, 0.00000000e+00,
           0.00000000e+00, 3.36539002e-01, 4.90755871e-01, 4.90755853e-01,
           4.90755871e-01, 9.58456727e-02, 9.58456698e-02, 9.58456725e-02],
         [ 0.00000000e+00, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 1.64454910e-01,
           0.00000000e+00, 0.00000000e+00, 3.81308463e-01, 0.00000000e+00,
          -3.81308463e-01, 5.09226934e-02, 0.00000000e+00,-5.09226935e-02],
         [ 0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 1.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           1.64454910e-01, 0.00000000e+00, 2.20148553e-01,-4.40297084e-01,
           2.20148553e-01,-2.94002320e-02, 5.88004621e-02,-2.94002320e-02],
         [ 0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           1.00000000e+00,-4.46376366e-02,-3.36539002e-01,-0.00000000e+00,
          -0.00000000e+00,-3.14185640e-01, 1.56477269e-01, 1.56477261e-01,
           1.56477269e-01,-1.09045300e-01,-1.09045297e-01,-1.09045300e-01],
         [ 6.39821020e-08, 2.66205137e-02, 0.00000000e+00, 0.00000000e+00,
          -4.46376366e-02, 1.00000000e+00, 2.48362390e-01, 0.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 5.31031725e-03, 5.31031704e-03,
           5.31031725e-03, 6.22758567e-02, 6.22758520e-02, 6.22758564e-02],
         [ 2.66205137e-02, 2.98706483e-01, 0.00000000e+00, 0.00000000e+00,
          -3.36539002e-01, 2.48362390e-01, 1.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 9.58456725e-02, 9.58456698e-02,
           9.58456725e-02, 4.90755871e-01, 4.90755853e-01, 4.90755871e-01],
         [ 0.00000000e+00, 0.00000000e+00, 1.64454910e-01, 0.00000000e+00,
          -0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 1.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 5.09226935e-02, 0.00000000e+00,
          -5.09226935e-02, 3.81308463e-01, 0.00000000e+00,-3.81308463e-01],
         [ 0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 1.64454910e-01,
          -0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           1.00000000e+00, 0.00000000e+00, 2.94002320e-02,-5.88004621e-02,
           2.94002320e-02,-2.20148553e-01, 4.40297084e-01,-2.20148553e-01],
         [ 4.46376366e-02, 3.36539002e-01, 0.00000000e+00, 0.00000000e+00,
          -3.14185640e-01, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 1.00000000e+00, 1.09045300e-01, 1.09045297e-01,
           1.09045300e-01,-1.56477269e-01,-1.56477261e-01,-1.56477269e-01],
         [ 6.22758564e-02, 4.90755871e-01, 3.81308463e-01, 2.20148553e-01,
           1.56477269e-01, 5.31031725e-03, 9.58456725e-02, 5.09226935e-02,
           2.94002320e-02, 1.09045300e-01, 1.00000000e+00, 1.69539651e-01,
           1.69539665e-01, 5.03359227e-02, 5.03359239e-02, 1.60346943e-02],
         [ 6.22758520e-02, 4.90755853e-01, 0.00000000e+00,-4.40297084e-01,
           1.56477261e-01, 5.31031704e-03, 9.58456698e-02, 0.00000000e+00,
          -5.88004621e-02, 1.09045297e-01, 1.69539651e-01, 1.00000000e+00,
           1.69539651e-01, 5.03359240e-02, 1.60346928e-02, 5.03359239e-02],
         [ 6.22758564e-02, 4.90755871e-01,-3.81308463e-01, 2.20148553e-01,
           1.56477269e-01, 5.31031725e-03, 9.58456725e-02,-5.09226935e-02,
           2.94002320e-02, 1.09045300e-01, 1.69539665e-01, 1.69539651e-01,
           1.00000000e+00, 1.60346943e-02, 5.03359239e-02, 5.03359227e-02],
         [ 5.31031726e-03, 9.58456727e-02, 5.09226934e-02,-2.94002320e-02,
          -1.09045300e-01, 6.22758567e-02, 4.90755871e-01, 3.81308463e-01,
          -2.20148553e-01,-1.56477269e-01, 5.03359227e-02, 5.03359240e-02,
           1.60346943e-02, 1.00000000e+00, 1.69539651e-01, 1.69539666e-01],
         [ 5.31031704e-03, 9.58456698e-02, 0.00000000e+00, 5.88004621e-02,
          -1.09045297e-01, 6.22758520e-02, 4.90755853e-01, 0.00000000e+00,
           4.40297084e-01,-1.56477261e-01, 5.03359239e-02, 1.60346928e-02,
           5.03359239e-02, 1.69539651e-01, 1.00000000e+00, 1.69539651e-01],
         [ 5.31031725e-03, 9.58456725e-02,-5.09226935e-02,-2.94002320e-02,
          -1.09045300e-01, 6.22758564e-02, 4.90755871e-01,-3.81308463e-01,
          -2.20148553e-01,-1.56477269e-01, 1.60346943e-02, 5.03359239e-02,
           5.03359227e-02, 1.69539666e-01, 1.69539651e-01, 1.00000000e+00]],
        [[ 1.00000000e+00, 2.48362390e-01, 0.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 5.77621968e-08, 2.62705645e-02, 8.82703195e-12,
          -1.05354471e-10, 4.40852084e-02, 6.31463256e-02, 6.31463274e-02,
           6.31463256e-02, 5.05711765e-03, 5.05711774e-03, 5.05711766e-03],
         [ 2.48362390e-01, 1.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 2.62705645e-02, 2.96383458e-01, 6.69958782e-11,
          -7.99624982e-10, 3.34600267e-01, 4.94181496e-01, 4.94181503e-01,
           4.94181496e-01, 9.25418363e-02, 9.25418374e-02, 9.25418364e-02],
         [ 0.00000000e+00, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00,
           0.00000000e+00,-8.82703195e-12,-6.69958782e-11, 1.62827141e-01,
           2.27869143e-19,-9.53510429e-11, 3.79277754e-01, 2.70089758e-11,
          -3.79277754e-01, 4.82203787e-02,-1.17494214e-11,-4.82203788e-02],
         [ 0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 1.00000000e+00,
           0.00000000e+00, 1.05354471e-10, 7.99624982e-10, 2.27869143e-19,
           1.62827141e-01, 1.13805622e-09, 2.18976112e-01,-4.37952230e-01,
           2.18976112e-01,-2.78400483e-02, 5.56800975e-02,-2.78400483e-02],
         [ 0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           1.00000000e+00,-4.40852084e-02,-3.34600267e-01,-9.53510429e-11,
           1.13805622e-09,-3.13388491e-01, 1.68666692e-01, 1.68666694e-01,
           1.68666692e-01,-1.06477883e-01,-1.06477884e-01,-1.06477883e-01],
         [ 5.77621968e-08, 2.62705645e-02,-8.82703195e-12, 1.05354471e-10,
          -4.40852084e-02, 1.00000000e+00, 2.48362390e-01, 0.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 5.05711765e-03, 5.05711774e-03,
           5.05711765e-03, 6.31463255e-02, 6.31463274e-02, 6.31463256e-02],
         [ 2.62705645e-02, 2.96383458e-01,-6.69958782e-11, 7.99624982e-10,
          -3.34600267e-01, 2.48362390e-01, 1.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 9.25418363e-02, 9.25418374e-02,
           9.25418363e-02, 4.94181495e-01, 4.94181503e-01, 4.94181496e-01],
         [ 8.82703195e-12, 6.69958782e-11, 1.62827141e-01, 2.27869143e-19,
          -9.53510429e-11, 0.00000000e+00, 0.00000000e+00, 1.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 4.82203788e-02, 2.04599287e-11,
          -4.82203787e-02, 3.79277754e-01, 4.15035859e-11,-3.79277754e-01],
         [-1.05354471e-10,-7.99624982e-10, 2.27869143e-19, 1.62827141e-01,
           1.13805622e-09, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           1.00000000e+00, 0.00000000e+00, 2.78400483e-02,-5.56800975e-02,
           2.78400483e-02,-2.18976112e-01, 4.37952230e-01,-2.18976112e-01],
         [ 4.40852084e-02, 3.34600267e-01,-9.53510429e-11, 1.13805622e-09,
          -3.13388491e-01, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 1.00000000e+00, 1.06477883e-01, 1.06477884e-01,
           1.06477883e-01,-1.68666692e-01,-1.68666694e-01,-1.68666692e-01],
         [ 6.31463256e-02, 4.94181496e-01, 3.79277754e-01, 2.18976112e-01,
           1.68666692e-01, 5.05711765e-03, 9.25418363e-02, 4.82203788e-02,
           2.78400483e-02, 1.06477883e-01, 1.00000000e+00, 1.76669398e-01,
           1.76669394e-01, 4.63786487e-02, 4.63786488e-02, 1.53545038e-02],
         [ 6.31463274e-02, 4.94181503e-01, 2.70089758e-11,-4.37952230e-01,
           1.68666694e-01, 5.05711774e-03, 9.25418374e-02, 2.04599287e-11,
          -5.56800975e-02, 1.06477884e-01, 1.76669398e-01, 1.00000000e+00,
           1.76669398e-01, 4.63786488e-02, 1.53545044e-02, 4.63786488e-02],
         [ 6.31463256e-02, 4.94181496e-01,-3.79277754e-01, 2.18976112e-01,
           1.68666692e-01, 5.05711765e-03, 9.25418363e-02,-4.82203787e-02,
           2.78400483e-02, 1.06477883e-01, 1.76669394e-01, 1.76669398e-01,
           1.00000000e+00, 1.53545038e-02, 4.63786488e-02, 4.63786487e-02],
         [ 5.05711765e-03, 9.25418363e-02, 4.82203787e-02,-2.78400483e-02,
          -1.06477883e-01, 6.31463255e-02, 4.94181495e-01, 3.79277754e-01,
          -2.18976112e-01,-1.68666692e-01, 4.63786487e-02, 4.63786488e-02,
           1.53545038e-02, 1.00000000e+00, 1.76669398e-01, 1.76669394e-01],
         [ 5.05711774e-03, 9.25418374e-02,-1.17494214e-11, 5.56800975e-02,
          -1.06477884e-01, 6.31463274e-02, 4.94181503e-01, 4.15035859e-11,
           4.37952230e-01,-1.68666694e-01, 4.63786488e-02, 1.53545044e-02,
           4.63786488e-02, 1.76669398e-01, 1.00000000e+00, 1.76669398e-01],
         [ 5.05711766e-03, 9.25418364e-02,-4.82203788e-02,-2.78400483e-02,
          -1.06477883e-01, 6.31463256e-02, 4.94181496e-01,-3.79277754e-01,
          -2.18976112e-01,-1.68666692e-01, 1.53545038e-02, 4.63786488e-02,
           4.63786487e-02, 1.76669394e-01, 1.76669398e-01, 1.00000000e+00]],
        [[ 1.00000000e+00, 2.48362390e-01, 0.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 6.86067550e-08, 2.68622960e-02, 9.04371246e-12,
          -2.26879833e-11, 4.50197012e-02, 6.28735494e-02, 6.28735496e-02,
           6.28735494e-02, 5.19205379e-03, 5.19205379e-03, 5.19205379e-03],
         [ 2.48362390e-01, 1.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 2.68622960e-02, 3.00303034e-01, 6.78717657e-11,
          -1.70270062e-10, 3.37866404e-01, 4.93112054e-01, 4.93112055e-01,
           4.93112054e-01, 9.43073474e-02, 9.43073474e-02, 9.43073474e-02],
         [ 0.00000000e+00, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00,
           0.00000000e+00,-9.04371246e-12,-6.78717657e-11, 1.65576859e-01,
           4.86237585e-20,-9.64839867e-11, 3.79542837e-01, 1.83674804e-11,
          -3.79542837e-01, 4.94390711e-02,-4.58023282e-12,-4.94390711e-02],
         [ 0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 1.00000000e+00,
           0.00000000e+00, 2.26879833e-11, 1.70270062e-10, 4.86237585e-20,
           1.65576859e-01, 2.42049610e-10, 2.19129159e-01,-4.38258318e-01,
           2.19129159e-01,-2.85436609e-02, 5.70873220e-02,-2.85436609e-02],
         [ 0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           1.00000000e+00,-4.50197012e-02,-3.37866404e-01,-9.64839867e-11,
           2.42049610e-10,-3.14721499e-01, 1.66093991e-01, 1.66093991e-01,
           1.66093991e-01,-1.07993717e-01,-1.07993717e-01,-1.07993717e-01],
         [ 6.86067550e-08, 2.68622960e-02,-9.04371246e-12, 2.26879833e-11,
          -4.50197012e-02, 1.00000000e+00, 2.48362390e-01, 0.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 5.19205379e-03, 5.19205379e-03,
           5.19205379e-03, 6.28735493e-02, 6.28735496e-02, 6.28735494e-02],
         [ 2.68622960e-02, 3.00303034e-01,-6.78717657e-11, 1.70270062e-10,
          -3.37866404e-01, 2.48362390e-01, 1.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 9.43073474e-02, 9.43073474e-02,
           9.43073474e-02, 4.93112054e-01, 4.93112055e-01, 4.93112054e-01],
         [ 9.04371246e-12, 6.78717657e-11, 1.65576859e-01, 4.86237585e-20,
          -9.64839867e-11, 0.00000000e+00, 0.00000000e+00, 1.00000000e+00,
           0.00000000e+00, 0.00000000e+00, 4.94390711e-02, 1.97405103e-11,
          -4.94390711e-02, 3.79542837e-01, 9.80176905e-11,-3.79542837e-01],
         [-2.26879833e-11,-1.70270062e-10, 4.86237585e-20, 1.65576859e-01,
           2.42049610e-10, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           1.00000000e+00, 0.00000000e+00, 2.85436609e-02,-5.70873220e-02,
           2.85436609e-02,-2.19129159e-01, 4.38258318e-01,-2.19129159e-01],
         [ 4.50197012e-02, 3.37866404e-01,-9.64839867e-11, 2.42049610e-10,
          -3.14721499e-01, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
           0.00000000e+00, 1.00000000e+00, 1.07993717e-01, 1.07993717e-01,
           1.07993717e-01,-1.66093991e-01,-1.66093991e-01,-1.66093991e-01],
         [ 6.28735494e-02, 4.93112054e-01, 3.79542837e-01, 2.19129159e-01,
           1.66093991e-01, 5.19205379e-03, 9.43073474e-02, 4.94390711e-02,
           2.85436609e-02, 1.07993717e-01, 1.00000000e+00, 1.74889496e-01,
           1.74889496e-01, 4.77407341e-02, 4.77407341e-02, 1.56480899e-02],
         [ 6.28735496e-02, 4.93112055e-01, 1.83674804e-11,-4.38258318e-01,
           1.66093991e-01, 5.19205379e-03, 9.43073474e-02, 1.97405103e-11,
          -5.70873220e-02, 1.07993717e-01, 1.74889496e-01, 1.00000000e+00,
           1.74889496e-01, 4.77407341e-02, 1.56480899e-02, 4.77407341e-02],
         [ 6.28735494e-02, 4.93112054e-01,-3.79542837e-01, 2.19129159e-01,
           1.66093991e-01, 5.19205379e-03, 9.43073474e-02,-4.94390711e-02,
           2.85436609e-02, 1.07993717e-01, 1.74889496e-01, 1.74889496e-01,
           1.00000000e+00, 1.56480899e-02, 4.77407341e-02, 4.77407341e-02],
         [ 5.19205379e-03, 9.43073474e-02, 4.94390711e-02,-2.85436609e-02,
          -1.07993717e-01, 6.28735493e-02, 4.93112054e-01, 3.79542837e-01,
          -2.19129159e-01,-1.66093991e-01, 4.77407341e-02, 4.77407341e-02,
           1.56480899e-02, 1.00000000e+00, 1.74889496e-01, 1.74889496e-01],
         [ 5.19205379e-03, 9.43073474e-02,-4.58023282e-12, 5.70873220e-02,
          -1.07993717e-01, 6.28735496e-02, 4.93112055e-01, 9.80176905e-11,
           4.38258318e-01,-1.66093991e-01, 4.77407341e-02, 1.56480899e-02,
           4.77407341e-02, 1.74889496e-01, 1.00000000e+00, 1.74889496e-01],
         [ 5.19205379e-03, 9.43073474e-02,-4.94390711e-02,-2.85436609e-02,
          -1.07993717e-01, 6.28735494e-02, 4.93112054e-01,-3.79542837e-01,
          -2.19129159e-01,-1.66093991e-01, 1.56480899e-02, 4.77407341e-02,
           4.77407341e-02, 1.74889496e-01, 1.74889496e-01, 1.00000000e+00]]]]

    hcores = [np.array(mat) for mat in \
       [[[-2.20138562e+01,-5.33421443e+00, 1.95850226e-12,-1.28233460e-09,
           4.52598412e-02,-3.69904612e-06,-5.79246196e-01, 4.63167780e-14,
          -2.40285929e-11,-9.70495682e-01,-1.34546830e+00,-1.34546820e+00,
          -1.34546830e+00,-1.15597035e-01,-1.15597031e-01,-1.15597035e-01],
         [-5.33421443e+00,-8.92251650e+00, 2.29191015e-11,-1.04975989e-08,
           5.40866431e-01,-5.79246196e-01,-2.74845805e+00,-6.93532211e-12,
           4.90565138e-10,-3.08425671e+00,-3.85079451e+00,-3.85079434e+00,
          -3.85079451e+00,-8.14307294e-01,-8.14307265e-01,-8.14307292e-01],
         [ 1.95850226e-12, 2.29191015e-11,-7.78559102e+00,-7.94338770e-13,
          -2.94619494e-12,-5.47511662e-13, 2.66646514e-12,-1.28822879e+00,
           4.77425738e-12, 8.62301159e-12,-2.65987080e+00, 9.26847011e-12,
           2.65987080e+00,-3.65285126e-01, 1.90212733e-12, 3.65285126e-01],
         [-1.28233460e-09,-1.04975989e-08,-7.94338770e-13,-7.78559102e+00,
          -4.66198618e-09, 2.47468541e-11,-4.47579123e-10, 4.77425738e-12,
          -1.28822880e+00,-1.35812811e-09,-1.53567719e+00, 3.07135420e+00,
          -1.53567719e+00, 2.10897475e-01,-4.21794934e-01, 2.10897474e-01],
         [ 4.52598412e-02, 5.40866431e-01,-2.94619494e-12,-4.66198618e-09,
          -8.05008806e+00, 9.70495682e-01, 3.08425671e+00, 1.69010882e-11,
          -1.40885207e-09, 2.84199903e+00,-9.17796810e-01,-9.17796754e-01,
          -9.17796810e-01, 9.25608932e-01, 9.25608896e-01, 9.25608930e-01],
         [-3.69904612e-06,-5.79246196e-01,-5.47511662e-13, 2.47468541e-11,
           9.70495682e-01,-2.20138562e+01,-5.33421443e+00,-3.10034266e-11,
           1.31933797e-09,-4.52598411e-02,-1.15597035e-01,-1.15597031e-01,
          -1.15597035e-01,-1.34546830e+00,-1.34546820e+00,-1.34546830e+00],
         [-5.79246196e-01,-2.74845805e+00, 2.66646514e-12,-4.47579123e-10,
           3.08425671e+00,-5.33421443e+00,-8.92251650e+00,-1.99010253e-10,
           1.08092856e-08,-5.40866431e-01,-8.14307292e-01,-8.14307265e-01,
          -8.14307292e-01,-3.85079452e+00,-3.85079434e+00,-3.85079451e+00],
         [ 4.63167780e-14,-6.93532211e-12,-1.28822879e+00, 4.77425738e-12,
           1.69010882e-11,-3.10034266e-11,-1.99010253e-10,-7.78559102e+00,
           1.75014704e-10, 1.24397008e-10,-3.65285126e-01,-2.25024816e-12,
           3.65285126e-01,-2.65987080e+00,-2.31553544e-11, 2.65987080e+00],
         [-2.40285929e-11, 4.90565138e-10, 4.77425738e-12,-1.28822880e+00,
          -1.40885207e-09, 1.31933797e-09, 1.08092856e-08, 1.75014704e-10,
          -7.78559102e+00,-4.77021556e-09,-2.10897474e-01, 4.21794934e-01,
          -2.10897474e-01, 1.53567719e+00,-3.07135420e+00, 1.53567719e+00],
         [-9.70495682e-01,-3.08425671e+00, 8.62301159e-12,-1.35812811e-09,
           2.84199903e+00,-4.52598411e-02,-5.40866431e-01, 1.24397008e-10,
          -4.77021556e-09,-8.05008806e+00,-9.25608930e-01,-9.25608896e-01,
          -9.25608930e-01, 9.17796813e-01, 9.17796755e-01, 9.17796810e-01],
         [-1.34546830e+00,-3.85079451e+00,-2.65987080e+00,-1.53567719e+00,
          -9.17796810e-01,-1.15597035e-01,-8.14307292e-01,-3.65285126e-01,
          -2.10897474e-01,-9.25608930e-01,-5.97564018e+00,-1.24361414e+00,
          -1.24361424e+00,-3.66344586e-01,-3.66344591e-01,-1.41742979e-01],
         [-1.34546820e+00,-3.85079434e+00, 9.26847011e-12, 3.07135420e+00,
          -9.17796754e-01,-1.15597031e-01,-8.14307265e-01,-2.25024816e-12,
           4.21794934e-01,-9.25608896e-01,-1.24361414e+00,-5.97564008e+00,
          -1.24361414e+00,-3.66344592e-01,-1.41742966e-01,-3.66344591e-01],
         [-1.34546830e+00,-3.85079451e+00, 2.65987080e+00,-1.53567719e+00,
          -9.17796810e-01,-1.15597035e-01,-8.14307292e-01, 3.65285126e-01,
          -2.10897474e-01,-9.25608930e-01,-1.24361424e+00,-1.24361414e+00,
          -5.97564018e+00,-1.41742980e-01,-3.66344591e-01,-3.66344586e-01],
         [-1.15597035e-01,-8.14307294e-01,-3.65285126e-01, 2.10897475e-01,
           9.25608932e-01,-1.34546830e+00,-3.85079452e+00,-2.65987080e+00,
           1.53567719e+00, 9.17796813e-01,-3.66344586e-01,-3.66344592e-01,
          -1.41742980e-01,-5.97564018e+00,-1.24361414e+00,-1.24361425e+00],
         [-1.15597031e-01,-8.14307265e-01, 1.90212733e-12,-4.21794934e-01,
           9.25608896e-01,-1.34546820e+00,-3.85079434e+00,-2.31553544e-11,
          -3.07135420e+00, 9.17796755e-01,-3.66344591e-01,-1.41742966e-01,
          -3.66344591e-01,-1.24361414e+00,-5.97564008e+00,-1.24361414e+00],
         [-1.15597035e-01,-8.14307292e-01, 3.65285126e-01, 2.10897474e-01,
           9.25608930e-01,-1.34546830e+00,-3.85079451e+00, 2.65987080e+00,
           1.53567719e+00, 9.17796810e-01,-1.41742979e-01,-3.66344591e-01,
          -3.66344586e-01,-1.24361425e+00,-1.24361414e+00,-5.97564018e+00]],
        [[-2.20083984e+01,-5.33285892e+00, 9.74031717e-12, 2.82319825e-10,
           4.33446266e-02,-3.35781608e-06,-5.71409358e-01,-1.91810724e-10,
           2.29658563e-09,-9.58116017e-01,-1.36383912e+00,-1.36383916e+00,
          -1.36383912e+00,-1.10055503e-01,-1.10055505e-01,-1.10055503e-01],
         [-5.33285892e+00,-8.91592491e+00, 1.15275814e-10, 1.60859026e-09,
           5.21576097e-01,-5.71409358e-01,-2.72017990e+00,-5.96319165e-10,
           7.18122118e-09,-3.05750968e+00,-3.87576838e+00,-3.87576845e+00,
          -3.87576838e+00,-7.86556534e-01,-7.86556545e-01,-7.86556535e-01],
         [ 9.74031717e-12, 1.15275814e-10,-7.77727036e+00, 3.95352175e-12,
          -6.21823426e-11, 1.92208759e-10, 6.21475584e-10,-1.27173425e+00,
          -2.13781557e-13, 8.25404617e-10,-2.64319161e+00,-1.53408789e-10,
           2.64319161e+00,-3.45484958e-01, 1.14730116e-10, 3.45484958e-01],
         [ 2.82319825e-10, 1.60859026e-09, 3.95352175e-12,-7.77727036e+00,
           2.14875032e-09,-2.29678311e-09,-7.18983854e-09,-2.13781340e-13,
          -1.27173425e+00,-9.44735511e-09,-1.52604738e+00, 3.05209480e+00,
          -1.52604738e+00, 1.99465831e-01,-3.98931669e-01, 1.99465831e-01],
         [ 4.33446266e-02, 5.21576097e-01,-6.21823426e-11, 2.14875032e-09,
          -8.04712744e+00, 9.58116017e-01, 3.05750968e+00, 7.95563522e-10,
          -9.43675097e-09, 2.82306069e+00,-1.00902937e+00,-1.00902938e+00,
          -1.00902937e+00, 9.03794781e-01, 9.03794794e-01, 9.03794782e-01],
         [-3.35781608e-06,-5.71409358e-01, 1.92208759e-10,-2.29678311e-09,
           9.58116017e-01,-2.20083984e+01,-5.33285892e+00, 1.05001394e-11,
          -2.93084204e-10,-4.33446266e-02,-1.10055503e-01,-1.10055505e-01,
          -1.10055503e-01,-1.36383912e+00,-1.36383916e+00,-1.36383912e+00],
         [-5.71409358e-01,-2.72017990e+00, 6.21475584e-10,-7.18983854e-09,
           3.05750968e+00,-5.33285892e+00,-8.91592491e+00, 4.59938129e-11,
          -1.68867265e-09,-5.21576097e-01,-7.86556534e-01,-7.86556545e-01,
          -7.86556535e-01,-3.87576838e+00,-3.87576845e+00,-3.87576838e+00],
         [-1.91810724e-10,-5.96319165e-10,-1.27173425e+00,-2.13781340e-13,
           7.95563522e-10, 1.05001394e-11, 4.59938129e-11,-7.77727036e+00,
          -3.02190512e-11,-9.81698750e-11,-3.45484958e-01,-1.71580146e-10,
           3.45484958e-01,-2.64319161e+00,-2.81823063e-10, 2.64319161e+00],
         [ 2.29658563e-09, 7.18122118e-09,-2.13781557e-13,-1.27173425e+00,
          -9.43675097e-09,-2.93084204e-10,-1.68867265e-09,-3.02190512e-11,
          -7.77727036e+00, 2.18415864e-09,-1.99465831e-01, 3.98931669e-01,
          -1.99465831e-01, 1.52604738e+00,-3.05209480e+00, 1.52604738e+00],
         [-9.58116017e-01,-3.05750968e+00, 8.25404617e-10,-9.44735511e-09,
           2.82306069e+00,-4.33446266e-02,-5.21576097e-01,-9.81698750e-11,
           2.18415864e-09,-8.04712744e+00,-9.03794782e-01,-9.03794794e-01,
          -9.03794782e-01, 1.00902937e+00, 1.00902938e+00, 1.00902937e+00],
         [-1.36383912e+00,-3.87576838e+00,-2.64319161e+00,-1.52604738e+00,
          -1.00902937e+00,-1.10055503e-01,-7.86556534e-01,-3.45484958e-01,
          -1.99465831e-01,-9.03794782e-01,-5.97749965e+00,-1.29126467e+00,
          -1.29126465e+00,-3.38934628e-01,-3.38934630e-01,-1.35653038e-01],
         [-1.36383916e+00,-3.87576845e+00,-1.53408789e-10, 3.05209480e+00,
          -1.00902938e+00,-1.10055505e-01,-7.86556545e-01,-1.71580146e-10,
           3.98931669e-01,-9.03794794e-01,-1.29126467e+00,-5.97749969e+00,
          -1.29126467e+00,-3.38934630e-01,-1.35653043e-01,-3.38934630e-01],
         [-1.36383912e+00,-3.87576838e+00, 2.64319161e+00,-1.52604738e+00,
          -1.00902937e+00,-1.10055503e-01,-7.86556535e-01, 3.45484958e-01,
          -1.99465831e-01,-9.03794782e-01,-1.29126465e+00,-1.29126467e+00,
          -5.97749965e+00,-1.35653038e-01,-3.38934630e-01,-3.38934629e-01],
         [-1.10055503e-01,-7.86556534e-01,-3.45484958e-01, 1.99465831e-01,
           9.03794781e-01,-1.36383912e+00,-3.87576838e+00,-2.64319161e+00,
           1.52604738e+00, 1.00902937e+00,-3.38934628e-01,-3.38934630e-01,
          -1.35653038e-01,-5.97749965e+00,-1.29126467e+00,-1.29126464e+00],
         [-1.10055505e-01,-7.86556545e-01, 1.14730116e-10,-3.98931669e-01,
           9.03794794e-01,-1.36383916e+00,-3.87576845e+00,-2.81823063e-10,
          -3.05209480e+00, 1.00902938e+00,-3.38934630e-01,-1.35653043e-01,
          -3.38934630e-01,-1.29126467e+00,-5.97749969e+00,-1.29126468e+00],
         [-1.10055503e-01,-7.86556535e-01, 3.45484958e-01, 1.99465831e-01,
           9.03794782e-01,-1.36383912e+00,-3.87576838e+00, 2.64319161e+00,
           1.52604738e+00, 1.00902937e+00,-1.35653038e-01,-3.38934630e-01,
          -3.38934629e-01,-1.29126464e+00,-1.29126468e+00,-5.97749965e+00]],
        [[-2.20211914e+01,-5.33603623e+00, 9.16887706e-12, 2.29174676e-11,
           4.43288017e-02,-3.95037843e-06,-5.84648460e-01,-1.96666640e-10,
           4.94190320e-10,-9.79048575e-01,-1.35874855e+00,-1.35874856e+00,
          -1.35874855e+00,-1.13060393e-01,-1.13060393e-01,-1.13060393e-01],
         [-5.33603623e+00,-8.92879927e+00, 1.09443955e-10, 8.12987342e-11,
           5.31779408e-01,-5.84648460e-01,-2.76339625e+00,-6.20934827e-10,
           1.54802328e-09,-3.09685516e+00,-3.87130201e+00,-3.87130202e+00,
          -3.87130201e+00,-8.02667252e-01,-8.02667253e-01,-8.02667253e-01],
         [ 9.16887706e-12, 1.09443955e-10,-7.78884256e+00, 6.17048838e-13,
          -5.78074342e-11, 1.96702448e-10, 6.23072579e-10,-1.29644603e+00,
           1.05117548e-13, 8.33243666e-10,-2.64797860e+00,-9.39253229e-11,
           2.64797860e+00,-3.54774346e-01, 6.15489764e-11, 3.54774346e-01],
         [ 2.29174676e-11, 8.12987342e-11, 6.17048838e-13,-7.78884256e+00,
           3.76876241e-10,-4.94208171e-10,-1.54826086e-09, 1.05117765e-13,
          -1.29644603e+00,-2.05085479e-09,-1.52881116e+00, 3.05762232e+00,
          -1.52881116e+00, 2.04829064e-01,-4.09658128e-01, 2.04829063e-01],
         [ 4.43288017e-02, 5.31779408e-01,-5.78074342e-11, 3.76876241e-10,
          -8.06246769e+00, 9.79048575e-01, 3.09685516e+00, 8.30691508e-10,
          -2.05050492e-09, 2.84650385e+00,-9.89460850e-01,-9.89460853e-01,
          -9.89460851e-01, 9.18220446e-01, 9.18220446e-01, 9.18220446e-01],
         [-3.95037843e-06,-5.84648460e-01, 1.96702448e-10,-4.94208171e-10,
           9.79048575e-01,-2.20211914e+01,-5.33603623e+00,-7.40038738e-12,
          -2.39954827e-11,-4.43288017e-02,-1.13060393e-01,-1.13060393e-01,
          -1.13060393e-01,-1.35874855e+00,-1.35874856e+00,-1.35874855e+00],
         [-5.84648460e-01,-2.76339625e+00, 6.23072579e-10,-1.54826086e-09,
           3.09685516e+00,-5.33603623e+00,-8.92879927e+00,-9.60099986e-11,
          -8.93830357e-11,-5.31779408e-01,-8.02667253e-01,-8.02667253e-01,
          -8.02667253e-01,-3.87130201e+00,-3.87130202e+00,-3.87130201e+00],
         [-1.96666640e-10,-6.20934827e-10,-1.29644603e+00, 1.05117765e-13,
           8.30691508e-10,-7.40038738e-12,-9.60099986e-11,-7.78884256e+00,
          -4.96838855e-12,-6.04063475e-11,-3.54774346e-01,-1.70581279e-10,
           3.54774346e-01,-2.64797860e+00,-7.15653045e-10, 2.64797860e+00],
         [ 4.94190320e-10, 1.54802328e-09, 1.05117548e-13,-1.29644603e+00,
          -2.05050492e-09,-2.39954827e-11,-8.93830357e-11,-4.96838855e-12,
          -7.78884256e+00, 3.83868445e-10,-2.04829064e-01, 4.09658128e-01,
          -2.04829064e-01, 1.52881116e+00,-3.05762232e+00, 1.52881116e+00],
         [-9.79048575e-01,-3.09685516e+00, 8.33243666e-10,-2.05085479e-09,
           2.84650385e+00,-4.43288017e-02,-5.31779408e-01,-6.04063475e-11,
           3.83868445e-10,-8.06246769e+00,-9.18220446e-01,-9.18220446e-01,
          -9.18220446e-01, 9.89460851e-01, 9.89460853e-01, 9.89460850e-01],
         [-1.35874855e+00,-3.87130201e+00,-2.64797860e+00,-1.52881116e+00,
          -9.89460850e-01,-1.13060393e-01,-8.02667253e-01,-3.54774346e-01,
          -2.04829064e-01,-9.18220446e-01,-5.98074797e+00,-1.28009193e+00,
          -1.28009192e+00,-3.48905536e-01,-3.48905536e-01,-1.38459306e-01],
         [-1.35874856e+00,-3.87130202e+00,-9.39253229e-11, 3.05762232e+00,
          -9.89460853e-01,-1.13060393e-01,-8.02667253e-01,-1.70581279e-10,
           4.09658128e-01,-9.18220446e-01,-1.28009193e+00,-5.98074797e+00,
          -1.28009193e+00,-3.48905536e-01,-1.38459306e-01,-3.48905536e-01],
         [-1.35874855e+00,-3.87130201e+00, 2.64797860e+00,-1.52881116e+00,
          -9.89460851e-01,-1.13060393e-01,-8.02667253e-01, 3.54774346e-01,
          -2.04829064e-01,-9.18220446e-01,-1.28009192e+00,-1.28009193e+00,
          -5.98074797e+00,-1.38459306e-01,-3.48905536e-01,-3.48905536e-01],
         [-1.13060393e-01,-8.02667252e-01,-3.54774346e-01, 2.04829064e-01,
           9.18220446e-01,-1.35874855e+00,-3.87130201e+00,-2.64797860e+00,
           1.52881116e+00, 9.89460851e-01,-3.48905536e-01,-3.48905536e-01,
          -1.38459306e-01,-5.98074797e+00,-1.28009193e+00,-1.28009192e+00],
         [-1.13060393e-01,-8.02667253e-01, 6.15489764e-11,-4.09658128e-01,
           9.18220446e-01,-1.35874856e+00,-3.87130202e+00,-7.15653045e-10,
          -3.05762232e+00, 9.89460853e-01,-3.48905536e-01,-1.38459306e-01,
          -3.48905536e-01,-1.28009193e+00,-5.98074797e+00,-1.28009193e+00],
         [-1.13060393e-01,-8.02667253e-01, 3.54774346e-01, 2.04829063e-01,
           9.18220446e-01,-1.35874855e+00,-3.87130201e+00, 2.64797860e+00,
           1.52881116e+00, 9.89460850e-01,-1.38459306e-01,-3.48905536e-01,
          -3.48905536e-01,-1.28009192e+00,-1.28009193e+00,-5.98074797e+00]]]]

    ref_guess = np.array(
        [[-7.00999975e-01, 7.01793087e-01,-1.65299915e-01, 1.46039753e-01,
          -1.54297591e-09, 2.99019728e-11,-2.22078350e-02,-3.24081551e-09,
           1.14817351e-10],
         [-3.10250483e-02, 2.27086076e-02, 4.53649219e-01,-4.39970537e-01,
           5.16174310e-09,-1.61702927e-10, 9.26316120e-02, 1.32582883e-08,
          -5.52478857e-10],
         [-3.91517710e-12, 3.11670794e-11, 1.98986076e-10,-1.17641936e-10,
           3.68277553e-03, 4.00294277e-01,-1.12179834e-09,-3.24752717e-03,
          -4.06981368e-01],
         [ 2.19110692e-10,-2.45948468e-10,-2.38943492e-09, 5.38616565e-09,
           4.00294276e-01,-3.68277582e-03, 6.94214102e-08,-4.06981368e-01,
           3.24752687e-03],
         [ 3.03206829e-03, 3.57609262e-03,-5.51260736e-02,-1.45832930e-01,
           2.66616219e-09,-2.63345082e-10,-5.41641133e-01,-9.16092925e-08,
           2.10977771e-09],
         [ 7.01000026e-01, 7.01793036e-01,-1.65299915e-01,-1.46039753e-01,
           1.53297497e-09,-6.21967625e-11,-2.22078351e-02,-3.29858716e-09,
           1.08174975e-10],
         [ 3.10250499e-02, 2.27086053e-02, 4.53649219e-01, 4.39970538e-01,
          -5.11250063e-09, 3.38157150e-10, 9.26316122e-02, 1.35945763e-08,
          -4.38224048e-10],
         [ 1.04191831e-11,-3.20990108e-11, 2.15884516e-11, 2.66200366e-10,
           3.68277543e-03, 4.00294276e-01, 9.26491845e-10, 3.24752707e-03,
           4.06981369e-01],
         [ 2.63604515e-10, 2.66533009e-10, 2.42324131e-09, 5.66555540e-09,
           4.00294276e-01,-3.68277554e-03,-6.92174110e-08, 4.06981369e-01,
          -3.24752716e-03],
         [ 3.03206807e-03,-3.57609282e-03, 5.51260736e-02,-1.45832930e-01,
           2.46340618e-09,-1.12432636e-10, 5.41641133e-01, 9.15809818e-08,
          -2.30310674e-09],
         [ 4.97829102e-03,-4.88454518e-03, 1.12777030e-01,-1.68856504e-01,
           1.59368538e-01, 2.70261520e-01,-1.42752045e-01,-1.97451581e-01,
          -3.35779746e-01],
         [ 4.97829100e-03,-4.88454503e-03, 1.12777033e-01,-1.68856509e-01,
          -3.13737608e-01, 2.88643969e-03,-1.42752143e-01, 3.89519545e-01,
          -3.10818910e-03],
         [ 4.97829103e-03,-4.88454522e-03, 1.12777030e-01,-1.68856503e-01,
           1.54369078e-01,-2.73147960e-01,-1.42752043e-01,-1.92068038e-01,
           3.38887937e-01],
         [-4.97829130e-03,-4.88454477e-03, 1.12777030e-01, 1.68856503e-01,
          -1.54369078e-01, 2.73147959e-01,-1.42752043e-01,-1.92068039e-01,
           3.38887938e-01],
         [-4.97829133e-03,-4.88454467e-03, 1.12777033e-01, 1.68856509e-01,
           3.13737607e-01,-2.88643918e-03,-1.42752143e-01, 3.89519544e-01,
          -3.10818895e-03],
         [-4.97829143e-03,-4.88454485e-03, 1.12777030e-01, 1.68856503e-01,
          -1.59368537e-01,-2.70261520e-01,-1.42752045e-01,-1.97451581e-01,
          -3.35779747e-01]])

    ref_coeffs = np.array([0.32452369, 0.67547631])

def tearDownModule():
    global mf, mol, mos, hcores, overlaps
    mol.stdout.close()
    del mf, mol, mos, hcores, overlaps

class KnownValues(unittest.TestCase):

    def test_grassmann_mapping(self):
        extrapolator = lib.gext.Extrapolator(nelectrons)
        for i in range(2):
            extrapolator.load_(hcores[i], mos[i], overlaps[i])

        for i, coeff in enumerate(extrapolator.coefficients):
            gamma = extrapolator._grassmann_log(coeff)
            coeff1 = extrapolator._grassmann_exp(gamma)

            d = coeff @ coeff.T
            d1 = coeff1[:,:nelectrons//2] @ coeff1[:,:nelectrons//2].T

            # check invertibility of the Grassmann mapping
            self.assertTrue(np.allclose(d, d1))

            # check the usual properties of the normalized densities
            self.assertTrue(np.isclose(np.trace(d), nelectrons//2))
            self.assertTrue(np.isclose(np.trace(d1), nelectrons//2))
            self.assertTrue(np.allclose(d, d.T))
            self.assertTrue(np.allclose(d1, d1.T))
            self.assertTrue(np.allclose(d, d @ d))
            self.assertTrue(np.allclose(d1, d1 @ d1))

            # check if the vector of the tangent point is zero
            if i == len(extrapolator.coefficients) - 1:
                self.assertTrue(
                    np.allclose(gamma, np.zeros(gamma.shape)))

    def test_fitting(self):
        fitting = lib.gext.Fitting()
        flattened_hcores = [hcore.flatten() for hcore in hcores]
        coeffs = fitting.fit(flattened_hcores[0:2], flattened_hcores[2])
        self.assertTrue(np.allclose(coeffs, ref_coeffs))

    def test_extrapolation(self):
        extrapolator = lib.gext.Extrapolator(nelectrons)
        for i in range(2):
            extrapolator.load_(hcores[i], mos[i], overlaps[i])
        guess = extrapolator.guess(hcores[2], overlaps[2])

        # test against the reference guess
        self.assertTrue(np.allclose(guess, ref_guess))

        # test if it is close to the actual density matrix
        d_guess = guess[:,:nelectrons//2] @ guess[:,:nelectrons//2].T
        d_ref = mos[2][:,:nelectrons//2] @ mos[2][:,:nelectrons//2].T
        self.assertTrue(np.linalg.norm(d_guess - d_ref, np.inf) < 1e-2)

    def test_optimization_geometric(self):
        from pyscf.geomopt.geometric_solver import optimize
        mol_eq = optimize(mf, gext=True)

    def test_optimization_berny(self):
        from pyscf.geomopt.berny_solver import optimize
        mol_eq = optimize(mf, gext=True)

if __name__ == "__main__":
    unittest.main()
